#!/usr/bin/perl

use warnings;

sub usage
{
	print "Usage: $0 src-file(s) dest-dir\n";
	print "Program to mkdir then $cmd\n";
	exit 1;
}

sub quote($)
{
	return "\"$_[0]\"";
}

sub basename($)
{
	my $_ = $_[0];
	return $1 if m|.*/([^/]+$)|;
	return $_;
}

sub mkdir_p($)
{
	$d = '';
	@d = map { $d = "$d/$_" } grep { length } split m|/|, $_[0];

	for(@d){
		if(!-d $_){
			mkdir $_ or die "mkdir $_: $!\n";
		}
	}
	return 1;
}

$progname = basename($0);

if($progname eq 'mkcp'){
	$iscopy = 1;
}elsif($progname eq 'mkmv'){
	$iscopy = 0;
}else{
	die "Invalid program name \"$progname\", expected \"mkcp\" or \"mkmv\"\n";
}

usage if(@ARGV < 2 or $ARGV[0] eq '--help');

if($ARGV[0] eq '-d'){
	shift;
	$debug = 1;
}

$last  = $ARGV[$#ARGV];
@files = map { quote$_ } @ARGV[0 .. $#ARGV-1];

$cmd  = $iscopy ? 'cp' : 'mv';
$args = $iscopy ? '-R' : '';

if($debug){
	print "mkdir $last\n$cmd $args @files $last\n";
}else{
	mkdir_p($last);
	exec("$cmd $args @files ".quote$last) or die "exec(): $!$/";
}
