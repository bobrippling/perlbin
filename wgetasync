#!/usr/bin/perl
use warnings;

use constant {
	MAX_CHILD => 150
};

our %downloads; # Map<PID, Link>
our %downloads_rev; # reverse of above, for lookup
our $children = 0;
my  $doneone = 0;

sub adddownload($)
{
	$link = $_[0];

	while($children >= MAX_CHILD){
		print STDERR "reached child limit of $children, waiting...\n";
		waitone();
	}

	die "fork: $!\n" unless defined($pid = fork());

	if($pid == 0){
		exec "wget -q '$link'";
		die "exec: $!\n";
	}

	$children++;
	$downloads{$pid} = $link;
	$downloads_rev{$link} = $pid;
}

sub waitone()
{
	$pid = wait();
	# status in $?

	if($pid == -1){
		# should never get here
		print "wait() returned -1, still have children...?:\n";
		print "pid: $_, link: $downloads{$_}\n" for keys %downloads;
		exit 1;
	}

	$children--;

	print "wget = $? for " . $downloads{$pid} . "\n";
	$errs{$downloads{$pid}} = $? if $?;

	delete $downloads{$pid};
}


for(@ARGV){
	if($_ eq '--help'){
		print "Usage: $0 [links...]\n";
		print "If no links are given, they are read on stdin\n";
		exit 1;
	}

	adddownload $_;
	$doneone = 1;
}

if(!$doneone){
	while(<STDIN>){
		chomp;
		adddownload $_;
	}
}

# collect downloads
waitone() while keys %downloads;

if(keys %errs){
	print STDERR "error $errs{$_} for $_\n" for keys %errs;
}
